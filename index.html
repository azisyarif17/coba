<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        
        <style>
        html, body {
            background-color: #ffffff;
            font-family: 'Poppins', sans-serif;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        }

        /* Legend Panel Styles */
        .legend-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 248, 0.98) 100%);
            border: 2px solid #1B263B;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            min-width: 280px;
            max-width: 320px;
            z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .legend-panel.collapsed {
            transform: translateX(calc(100% - 45px));
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #1B263B;
        }

        .legend-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1B263B;
            margin: 0;
        }

        .legend-toggle {
            background: linear-gradient(135deg, #1B263B 0%, #415A77 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(27, 38, 59, 0.3);
            font-size: 0.8rem;
        }

        .legend-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(27, 38, 59, 0.4);
        }

        .legend-content {
            transition: all 0.3s ease;
            max-height: 500px;
            overflow-y: auto;
        }

        .legend-panel.collapsed .legend-content {
            display: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background-color: rgba(27, 38, 59, 0.08);
            border-color: rgba(27, 38, 59, 0.2);
            transform: translateX(3px);
        }

        .legend-symbol {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 2px solid #333;
            border-radius: 3px;
            flex-shrink: 0;
            position: relative;
        }

        .legend-symbol.polygon {
            background-color: var(--symbol-color);
            opacity: 0.7;
        }

        .legend-symbol.line {
            background: linear-gradient(to right, transparent 0%, var(--symbol-color) 20%, var(--symbol-color) 80%, transparent 100%);
            height: 4px;
            margin-top: 8px;
            margin-bottom: 8px;
            border: none;
            border-radius: 2px;
        }

        .legend-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .legend-checkbox {
            margin-left: 8px;
            transform: scale(1.1);
            accent-color: #1B263B;
        }

        /* Layer Control Panel */
        .layer-control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 248, 0.98) 100%);
            border: 2px solid #1B263B;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            min-width: 260px;
            z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .layer-control-panel.collapsed {
            transform: translateX(calc(-100% + 45px));
        }

        .layer-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #1B263B;
        }

        .layer-control-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1B263B;
            margin: 0;
        }

        .layer-control-toggle {
            background: linear-gradient(135deg, #1B263B 0%, #415A77 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(27, 38, 59, 0.3);
            font-size: 0.8rem;
        }

        .layer-control-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(27, 38, 59, 0.4);
        }

        .layer-control-content {
            transition: all 0.3s ease;
            max-height: 400px;
            overflow-y: auto;
        }

        .layer-control-panel.collapsed .layer-control-content {
            display: none;
        }

        .basemap-selector {
            margin-bottom: 15px;
        }

        .basemap-selector label {
            display: block;
            font-weight: 500;
            color: #1B263B;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .basemap-selector select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #1B263B;
            border-radius: 6px;
            background: white;
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .basemap-selector select:focus {
            outline: none;
            border-color: #415A77;
            box-shadow: 0 0 0 3px rgba(65, 90, 119, 0.2);
        }

        .layer-group {
            margin-bottom: 15px;
        }

        .layer-group-title {
            font-weight: 600;
            color: #1B263B;
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 4px;
        }

        .layer-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .layer-item:hover {
            background-color: rgba(27, 38, 59, 0.05);
            border-color: rgba(27, 38, 59, 0.1);
        }

        .layer-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #1B263B;
        }

        .layer-item label {
            font-size: 0.85rem;
            color: #333;
            cursor: pointer;
            flex-grow: 1;
            font-weight: 500;
        }

        .opacity-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
            padding-left: 20px;
        }

        .opacity-label {
            font-size: 0.75rem;
            color: #666;
            margin-right: 8px;
            min-width: 60px;
        }

        .opacity-slider {
            flex-grow: 1;
            accent-color: #1B263B;
            height: 4px;
        }

        .opacity-value {
            font-size: 0.75rem;
            color: #666;
            margin-left: 8px;
            min-width: 30px;
        }

        /* Map Info Panel */
        .map-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 248, 0.98) 100%);
            border: 2px solid #1B263B;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            max-width: 280px;
            z-index: 2000;
        }

        .map-info h4 {
            margin: 0 0 8px 0;
            color: #1B263B;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .map-info p {
            margin: 0 0 4px 0;
            font-size: 0.75rem;
            color: #666;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .legend-panel, .layer-control-panel {
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                min-width: auto;
                z-index: 3000;
            }
            
            .legend-panel {
                top: auto;
                bottom: 10px;
            }
            
            .map-info {
                display: none;
            }
        }

        /* Custom scrollbar */
        .legend-content::-webkit-scrollbar,
        .layer-control-content::-webkit-scrollbar {
            width: 6px;
        }

        .legend-content::-webkit-scrollbar-track,
        .layer-control-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .legend-content::-webkit-scrollbar-thumb,
        .layer-control-content::-webkit-scrollbar-thumb {
            background: #1B263B;
            border-radius: 3px;
        }

        .legend-content::-webkit-scrollbar-thumb:hover,
        .layer-control-content::-webkit-scrollbar-thumb:hover {
            background: #415A77;
        }
        </style>

        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title>SITAU - Peta Interaktif Desa Bawu</title>
    </head>
    <body>
        <div id="map">
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
        </div>

        <!-- Layer Control Panel -->
        <div class="layer-control-panel" id="layerControlPanel">
            <div class="layer-control-header">
                <h3 class="layer-control-title">Kontrol Layer</h3>
                <button class="layer-control-toggle" id="layerControlToggle">
                    ◀
                </button>
            </div>
            <div class="layer-control-content">
                <!-- Basemap Selector -->
                <div class="basemap-selector">
                    <label for="basemapSelect">Peta Dasar:</label>
                    <select id="basemapSelect">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Citra Satelit</option>
                        <option value="terrain">Terrain</option>
                        <option value="topo">Topografi</option>
                    </select>
                </div>

                <!-- Data Layers -->
                <div class="layer-group">
                    <div class="layer-group-title">Layer Data Pertanahan</div>
                    
                    <div class="layer-item">
                        <div class="layer-item-header">
                            <input type="checkbox" id="bidangTanahLayer" checked>
                            <label for="bidangTanahLayer">Bidang Tanah</label>
                        </div>
                        <div class="opacity-container">
                            <span class="opacity-label">Opacity:</span>
                            <input type="range" class="opacity-slider" id="bidangTanahOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="bidangTanahOpacityValue">100%</span>
                        </div>
                    </div>
                    
                    <div class="layer-item">
                        <div class="layer-item-header">
                            <input type="checkbox" id="hakLayer" checked>
                            <label for="hakLayer">Hak Kepemilikan</label>
                        </div>
                        <div class="opacity-container">
                            <span class="opacity-label">Opacity:</span>
                            <input type="range" class="opacity-slider" id="hakOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="hakOpacityValue">100%</span>
                        </div>
                    </div>
                    
                    <div class="layer-item">
                        <div class="layer-item-header">
                            <input type="checkbox" id="plLayer" checked>
                            <label for="plLayer">Penggunaan Lahan</label>
                        </div>
                        <div class="opacity-container">
                            <span class="opacity-label">Opacity:</span>
                            <input type="range" class="opacity-slider" id="plOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="plOpacityValue">100%</span>
                        </div>
                    </div>
                    
                    <div class="layer-item">
                        <div class="layer-item-header">
                            <input type="checkbox" id="zntLayer" checked>
                            <label for="zntLayer">Zona Nilai Tanah</label>
                        </div>
                        <div class="opacity-container">
                            <span class="opacity-label">Opacity:</span>
                            <input type="range" class="opacity-slider" id="zntOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="zntOpacityValue">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend Panel -->
        <div class="legend-panel" id="legendPanel">
            <div class="legend-header">
                <h3 class="legend-title">Legenda Peta</h3>
                <button class="legend-toggle" id="legendToggle">
                    ▶
                </button>
            </div>
            <div class="legend-content">
                <!-- Bidang Tanah Legend -->
                <div class="legend-item" data-layer="bidangTanah">
                    <div class="legend-symbol polygon" style="--symbol-color: #ff6b6b; border-color: #e55656;"></div>
                    <span class="legend-label">Bidang Tanah</span>
                    <input type="checkbox" class="legend-checkbox" id="legendBidangTanah" checked>
                </div>

                <!-- Hak Kepemilikan Legend -->
                <div class="legend-item" data-layer="hak">
                    <div class="legend-symbol polygon" style="--symbol-color: #4ecdc4; border-color: #45b7aa;"></div>
                    <span class="legend-label">Hak Kepemilikan</span>
                    <input type="checkbox" class="legend-checkbox" id="legendHak" checked>
                </div>

                <!-- Penggunaan Lahan Legend -->
                <div class="legend-item" data-layer="pl">
                    <div class="legend-symbol polygon" style="--symbol-color: #45b7d1; border-color: #3a9bc1;"></div>
                    <span class="legend-label">Penggunaan Lahan</span>
                    <input type="checkbox" class="legend-checkbox" id="legendPl" checked>
                </div>

                <!-- Zona Nilai Tanah Legend -->
                <div class="legend-item" data-layer="znt">
                    <div class="legend-symbol polygon" style="--symbol-color: #f9ca24; border-color: #f0b90b;"></div>
                    <span class="legend-label">Zona Nilai Tanah</span>
                    <input type="checkbox" class="legend-checkbox" id="legendZnt" checked>
                </div>

                <!-- Additional Legend Items -->
                <div class="legend-item">
                    <div class="legend-symbol line" style="--symbol-color: #6c5ce7;"></div>
                    <span class="legend-label">Batas Administrasi</span>
                    <input type="checkbox" class="legend-checkbox" checked>
                </div>

                <div class="legend-item">
                    <div class="legend-symbol line" style="--symbol-color: #2d3436;"></div>
                    <span class="legend-label">Jalan Utama</span>
                    <input type="checkbox" class="legend-checkbox" checked>
                </div>

                <div class="legend-item">
                    <div class="legend-symbol polygon" style="--symbol-color: #fd79a8; border-color: #e84393;"></div>
                    <span class="legend-label">Area Pemukiman</span>
                    <input type="checkbox" class="legend-checkbox" checked>
                </div>

                <div class="legend-item">
                    <div class="legend-symbol polygon" style="--symbol-color: #00b894; border-color: #00a085;"></div>
                    <span class="legend-label">Area Pertanian</span>
                    <input type="checkbox" class="legend-checkbox" checked>
                </div>
            </div>
        </div>

        <!-- Map Information Panel -->
        <div class="map-info">
            <h4>ℹ️ Informasi Peta</h4>
            <p><strong>Lokasi:</strong> Desa Bawu, Kemusu, Boyolali</p>
            <p><strong>Koordinat:</strong> <span id="mouseCoords">-</span></p>
            <p><strong>Skala:</strong> <span id="mapScale">1:10,000</span></p>
            <p><strong>Proyeksi:</strong> EPSG:3857 (Web Mercator)</p>
        </div>

        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="layers/BidangTanah_Bawu_1.js"></script>
        <script src="layers/Hak_Bawu_2.js"></script>
        <script src="layers/PL_Bawu_3.js"></script>
        <script src="layers/ZNT_Bawu_4.js"></script>
        <script src="styles/BidangTanah_Bawu_1_style.js"></script>
        <script src="styles/Hak_Bawu_2_style.js"></script>
        <script src="styles/PL_Bawu_3_style.js"></script>
        <script src="styles/ZNT_Bawu_4_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>

        <script>
        // Wait for map to be initialized
        let mapInitialized = false;
        let layerReferences = {};

        // Function to wait for map initialization
        function waitForMap() {
            if (typeof map !== 'undefined' && map) {
                mapInitialized = true;
                initializeControls();
                setupLayerReferences();
            } else {
                setTimeout(waitForMap, 100);
            }
        }

        // Setup layer references
        function setupLayerReferences() {
            if (typeof lyr_BidangTanah_Bawu_1 !== 'undefined') {
                layerReferences.bidangTanah = lyr_BidangTanah_Bawu_1;
            }
            if (typeof lyr_Hak_Bawu_2 !== 'undefined') {
                layerReferences.hak = lyr_Hak_Bawu_2;
            }
            if (typeof lyr_PL_Bawu_3 !== 'undefined') {
                layerReferences.pl = lyr_PL_Bawu_3;
            }
            if (typeof lyr_ZNT_Bawu_4 !== 'undefined') {
                layerReferences.znt = lyr_ZNT_Bawu_4;
            }
        }

        // Initialize all controls
        function initializeControls() {
            // Legend Panel Toggle
            const legendPanel = document.getElementById('legendPanel');
            const legendToggle = document.getElementById('legendToggle');
            
            legendToggle.addEventListener('click', function() {
                legendPanel.classList.toggle('collapsed');
                legendToggle.textContent = legendPanel.classList.contains('collapsed') ? '◀' : '▶';
            });

            // Layer Control Panel Toggle
            const layerControlPanel = document.getElementById('layerControlPanel');
            const layerControlToggle = document.getElementById('layerControlToggle');
            
            layerControlToggle.addEventListener('click', function() {
                layerControlPanel.classList.toggle('collapsed');
                layerControlToggle.textContent = layerControlPanel.classList.contains('collapsed') ? '▶' : '◀';
            });

            // Basemap Switching
            const basemapSelect = document.getElementById('basemapSelect');
            basemapSelect.addEventListener('change', function() {
                switchBasemap(this.value);
            });

            // Layer Visibility Controls
            setupLayerControls();

            // Opacity Controls
            setupOpacityControls();

            // Legend Checkbox Controls
            setupLegendControls();

            // Mouse coordinate tracking
            setupCoordinateTracking();

            // Scale tracking
            setupScaleTracking();
        }

        // Setup layer visibility controls
        function setupLayerControls() {
            const layerCheckboxes = {
                'bidangTanahLayer': 'bidangTanah',
                'hakLayer': 'hak',
                'plLayer': 'pl',
                'zntLayer': 'znt'
            };

            Object.keys(layerCheckboxes).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const layerKey = layerCheckboxes[checkboxId];
                        toggleLayerVisibility(layerKey, this.checked);
                        
                        // Sync with legend
                        const legendCheckbox = document.getElementById('legend' + layerKey.charAt(0).toUpperCase() + layerKey.slice(1));
                        if (legendCheckbox) {
                            legendCheckbox.checked = this.checked;
                        }
                    });
                }
            });
        }

        // Setup opacity controls
        function setupOpacityControls() {
            const opacitySliders = {
                'bidangTanahOpacity': 'bidangTanah',
                'hakOpacity': 'hak',
                'plOpacity': 'pl',
                'zntOpacity': 'znt'
            };

            Object.keys(opacitySliders).forEach(sliderId => {
                const slider = document.getElementById(sliderId);
                const valueDisplay = document.getElementById(sliderId + 'Value');
                
                if (slider && valueDisplay) {
                    slider.addEventListener('input', function() {
                        const layerKey = opacitySliders[sliderId];
                        const opacity = this.value / 100;
                        setLayerOpacity(layerKey, opacity);
                        valueDisplay.textContent = this.value + '%';
                    });
                }
            });
        }

        // Setup legend controls
        function setupLegendControls() {
            const legendCheckboxes = {
                'legendBidangTanah': 'bidangTanah',
                'legendHak': 'hak',
                'legendPl': 'pl',
                'legendZnt': 'znt'
            };

            Object.keys(legendCheckboxes).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const layerKey = legendCheckboxes[checkboxId];
                        toggleLayerVisibility(layerKey, this.checked);
                        
                        // Sync with layer control
                        const layerCheckbox = document.getElementById(layerKey + 'Layer');
                        if (layerCheckbox) {
                            layerCheckbox.checked = this.checked;
                        }
                    });
                }
            });
        }

        // Setup coordinate tracking
        function setupCoordinateTracking() {
            if (map) {
                map.on('pointermove', function(evt) {
                    const coordinate = ol.proj.toLonLat(evt.coordinate);
                    const coords = coordinate[1].toFixed(6) + '°, ' + coordinate[0].toFixed(6) + '°';
                    const coordsElement = document.getElementById('mouseCoords');
                    if (coordsElement) {
                        coordsElement.textContent = coords;
                    }
                });
            }
        }

        // Setup scale tracking
        function setupScaleTracking() {
            if (map) {
                map.getView().on('change:resolution', function() {
                    const resolution = map.getView().getResolution();
                    const units = map.getView().getProjection().getUnits();
                    const dpi = 25.4 / 0.28;
                    const mpu = ol.proj.METERS_PER_UNIT[units];
                    const scale = resolution * mpu * 39.37 * dpi;
                    const scaleElement = document.getElementById('mapScale');
                    if (scaleElement) {
                        scaleElement.textContent = '1:' + Math.round(scale).toLocaleString();
                    }
                });
            }
        }

        // Basemap switching function
        function switchBasemap(basemapType) {
            if (!map) return;
            
            // Remove existing base layer
            const layers = map.getLayers().getArray();
            const baseLayer = layers[0]; // Assuming first layer is base layer
            
            let newBaseLayer;
            
            switch(basemapType) {
                case 'satellite':
                    newBaseLayer = new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                            attributions: 'Tiles © Esri'
                        })
                    });
                    break;
                case 'terrain':
                    newBaseLayer = new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',
                            attributions: 'Tiles © Esri'
                        })
                    });
                    break;
                case 'topo':
                    newBaseLayer = new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                            attributions: 'Tiles © Esri'
                        })
                    });
                    break;
                default: // osm
                    newBaseLayer = new ol.layer.Tile({
                        source: new ol.source.OSM()
                    });
            }
            
            // Replace base layer
            map.getLayers().setAt(0, newBaseLayer);
        }

        // Layer visibility toggle function
        function toggleLayerVisibility(layerKey, visible) {
            const layer = layerReferences[layerKey];
            if (layer) {
                layer.setVisible(visible);
            }
        }

        // Layer opacity function
        function setLayerOpacity(layerKey, opacity) {
            const layer = layerReferences[layerKey];
            if (layer) {
                layer.setOpacity(opacity);
            }
        }

        // Responsive behavior
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                const legendPanel = document.getElementById('legendPanel');
                const layerControlPanel = document.getElementById('layerControlPanel');
                
                if (legendPanel && !legendPanel.classList.contains('collapsed')) {
                    legendPanel.classList.add('collapsed');
                    document.getElementById('legendToggle').textContent = '◀';
                }
                
                if (layerControlPanel && !layerControlPanel.classList.contains('collapsed')) {
                    layerControlPanel.classList.add('collapsed');
                    document.getElementById('layerControlToggle').textContent = '▶';
                }
            }
        });

        // Start initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            waitForMap();
        });

        // Also try to initialize immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForMap);
        } else {
            waitForMap();
        }
        </script>
    </body>
</html>
